# InLineRCRepo 项目流程快速参考

> 快速理解项目整体流程和数据调用关系的参考指南

---

## 🎯 项目核心目标

通过引入**Recent Changes (RC)上下文**增强InlineEdit代码生成质量，构建高质量的Java代码补全Benchmark。

---

## 📊 数据规模

- **总数据量**: 40条高质量benchmark
- **数据版本**: 3RC (完整) / 2RC (中等) / 1RC (精简)
- **数据来源**: Zeta数据集 + ShenYu项目
- **处理成功率**: 100%

---

## 🔄 五大处理阶段

### 1️⃣ 数据获取
```bash
# 下载Zeta数据集
python edit_prediction/download_zeta_dataset.py
```
**输出**: `zeta_full/` + `zeta_exports/*.jsonl`

---

### 2️⃣ 数据解析
```python
# 核心: data_processor.py
GitDiffRecord → CodeContext → RecentChanges
```
**关键类**:
- `GitDiffRecord`: Git Diff原始数据
- `CursorPositionInferrer`: 光标位置推断
- `ContextExtractor`: 上下文提取
- `RecentChangesBuilder`: RC构建

---

### 3️⃣ Benchmark构建
```bash
# 端到端处理
python scripts/run_end_to_end.py benchmark/input.jsonl 20-40
```
**流程**:
1. 加载原始数据
2. 提取代码信息
3. 调用GPT生成RC
4. 构建完整prompt
5. 保存为JSONL

---

### 4️⃣ 格式标准化
```bash
# 生成separated格式
python scripts/generate_separated_benchmark.py

# 修复RC格式
python tools/fix_rc_strict.py
```
**关键步骤**:
- 分离context above/below
- 添加行号标注
- 修复diff格式
- 验证数据质量

---

### 5️⃣ 多版本生成
```bash
# 创建1RC/2RC/3RC版本
python create_multi_rc_benchmarks.py
```
**输出**:
- `nl2code_java_complete_3RC.jsonl` (40条)
- `nl2code_java_complete_2RC.jsonl` (40条)
- `nl2code_java_complete_1RC.jsonl` (40条)

---

## 📁 核心文件结构

```
InLineRCRepo/
├── benchmark/                    # Benchmark数据
│   ├── nl2code_java_complete_3RC.jsonl  ← 最终输出
│   ├── nl2code_java_complete_2RC.jsonl  ← 最终输出
│   └── nl2code_java_complete_1RC.jsonl  ← 最终输出
│
├── edit_prediction/              # 数据下载
│   └── download_zeta_dataset.py
│
├── zeta_full/                    # Zeta数据处理
│   └── data_processor.py
│
├── scripts/                      # 核心脚本
│   ├── run_end_to_end.py        ← 一键处理
│   ├── end_to_end_processor.py
│   ├── generate_separated_benchmark.py
│   └── validate_separated_benchmark.py
│
├── tools/                        # 工具脚本
│   └── fix_rc_strict.py         ← RC修复
│
└── create_multi_rc_benchmarks.py ← 多版本生成
```

---

## 🔑 关键数据结构

### Benchmark格式
```json
{
  "prompt": "完整prompt (含context + RC + 功能描述)",
  "domain": "nl2code_java",
  "id": "项目名_用户ID#编号",
  "good_example_response": "```java\n期望代码\n```",
  "reward_command": "mvn test命令",
  "extra_content": {
    "query": "功能描述",
    "file_path": "源文件路径",
    "start_line": 起始行,
    "end_line": 结束行
  }
}
```

### Prompt结构
```
1. 外部类信息
2. Context Above (带行号)
3. Context Below (带行号)
4. Recent Changes (3个/2个/1个)
   - RC3: Earliest preparation
   - RC2: Intermediate preparation
   - RC1: Latest preparation
5. 功能描述
6. 代码片段
```

### Recent Change格式
```diff
### Recent Change 1 (Latest preparation work)
```diff
@@ -10,3 +10,4 @@
  10:     private static final Logger LOGGER = ...;
- 11:     // TODO: implement
+ 11:     private void processData() {
+ 12:         LOGGER.info("Processing...");
+ 13:     }
  14: }
```
```

---

## 🛠️ 常用命令

### 处理新数据
```bash
# 端到端处理
python scripts/run_end_to_end.py benchmark/nl2code_F40-60.jsonl 40-60
```

### 修复现有数据
```bash
# 修复RC格式
python tools/fix_rc_strict.py

# 验证数据质量
python scripts/validate_separated_benchmark.py
```

### 生成多版本
```bash
# 创建1RC/2RC/3RC版本
python create_multi_rc_benchmarks.py
```

---

## 🔍 数据流向速查

### 完整流程
```
HuggingFace (Zeta)
    ↓ download_zeta_dataset.py
zeta_exports/train.jsonl
    ↓ data_processor.py
GitDiffRecord
    ↓ extract_context
CodeContext
    ↓ build_recent_changes
RecentChanges
    ↓ end_to_end_processor.py
原始Benchmark
    ↓ generate_separated_benchmark.py
Separated格式
    ↓ fix_rc_strict.py
修复后Benchmark
    ↓ create_multi_rc_benchmarks.py
3RC/2RC/1RC版本
```

### 关键转换点
1. **Zeta → GitDiffRecord**: 原始数据解析
2. **GitDiffRecord → CodeContext**: 上下文提取
3. **CodeContext → RecentChanges**: RC生成
4. **RecentChanges → Benchmark**: Prompt构建
5. **Benchmark → Separated**: 格式标准化
6. **Separated → Fixed**: 质量修复
7. **Fixed → Multi-version**: 多版本生成

---

## 📋 质量检查清单

### 数据完整性
- [ ] 所有字段都存在 (prompt, domain, id, response)
- [ ] extra_content包含必要信息
- [ ] 代码片段完整

### 格式正确性
- [ ] 行号连续且正确
- [ ] Diff格式标准 (@@头 + 行号 + +/-)
- [ ] 代码缩进保留

### RC质量
- [ ] RC数量正确 (3/2/1)
- [ ] RC优先级正确 (rc1 > rc2 > rc3)
- [ ] Diff行号与context对应

### 代码质量
- [ ] 编译通过
- [ ] 测试通过
- [ ] 符合代码规范

---

## 🐛 常见问题

### 问题1: 行号不对齐
**解决**: 运行 `improve_line_numbers.py`

### 问题2: Diff格式错误
**解决**: 运行 `fix_rc_strict.py`

### 问题3: 代码片段不完整
**检查**: `extract_code_info()` 函数的marker定位

### 问题4: 缩进丢失
**原因**: 字符串处理破坏缩进
**解决**: 从context获取原始内容

---

## 📚 详细文档

- **整体流程**: [项目整体流程与数据调用解析.md](项目整体流程与数据调用解析.md)
- **调用关系**: [数据调用关系详解.md](数据调用关系详解.md)
- **技术方案**: [InlineEdit_Recent_Changes_Technical_Proposal.md](InlineEdit_Recent_Changes_Technical_Proposal.md)
- **快速开始**: [QUICK_START.md](QUICK_START.md)
- **执行记录**: [instruction.md](instruction.md)

---

## 🎓 核心概念

### Recent Changes (RC)
代码演进历史中的最近3次变更，按时间倒序排列：
- **RC1**: 最近的准备工作 (优先级最高)
- **RC2**: 中间的准备工作
- **RC3**: 最早的准备工作

### Separated格式
将代码上下文分离为above和below两部分，便于：
- 精确定位插入点
- 保持代码结构清晰
- 支持行号标注

### Unified Diff格式
标准的Git diff格式：
```diff
@@ -旧起始行,旧行数 +新起始行,新行数 @@
 上下文行
-删除的行
+添加的行
 上下文行
```

---

## 💡 最佳实践

### 1. 数据处理
- 始终备份原始数据
- 每个阶段都验证输出
- 保留处理日志

### 2. RC生成
- 使用高质量的prompt模板
- 验证RC与context的对应关系
- 确保diff格式标准

### 3. 多版本管理
- 保持ID一致性
- 只修改RC数量
- 验证所有版本的数据完整性

### 4. 质量保证
- 运行完整的验证脚本
- 检查边界情况
- 确保100%成功率

---

## 🚀 快速上手

### 第一次使用
```bash
# 1. 下载数据
python edit_prediction/download_zeta_dataset.py

# 2. 处理数据
python scripts/run_end_to_end.py benchmark/input.jsonl 1-10

# 3. 生成多版本
python create_multi_rc_benchmarks.py

# 4. 验证质量
python scripts/validate_separated_benchmark.py
```

### 日常使用
```bash
# 修复RC格式
python tools/fix_rc_strict.py

# 验证数据
python scripts/validate_separated_benchmark.py
```

---

**最后更新**: 2025-09-30  
**版本**: v3.0 (完整文档版)

