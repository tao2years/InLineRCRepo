# Recent Changes Benchmark ä¿®å¤æµç¨‹æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†ä¿®å¤ Recent Changes éƒ¨åˆ†è¡Œå·å¯¹é½å’Œdiffæ ¼å¼é—®é¢˜çš„å®Œæ•´æµç¨‹ï¼Œä¾›åˆå­¦è€…æˆ–æ— è®°å¿†çš„Agentå‚è€ƒã€‚

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

åœ¨ `benchmark/nl2code_java_F20-40_with_rc_separated_final.jsonl` æ–‡ä»¶ä¸­ï¼ŒRecent Changes éƒ¨åˆ†å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1. **è¡Œå·ä¸å¯¹é½**: Recent Changesä¸­çš„è¡Œå·ä¸context codeä¸å¯¹åº”
2. **diffæ ¼å¼é”™è¯¯**: å‡å·è¡Œå’ŒåŠ å·è¡Œäº¤é”™æ˜¾ç¤ºï¼Œä¸ç¬¦åˆæ ‡å‡†diffæ ¼å¼
3. **ç¼©è¿›ä¸¢å¤±**: ä»£ç ç¼©è¿›ä¸contextä¸­çš„åŸå§‹ç¼©è¿›ä¸ä¸€è‡´
4. **è¡Œå·é¡ºåºé”™è¯¯**: å‡å·è¡Œæˆ–åŠ å·è¡Œå†…éƒ¨é¡ºåºä¸æ˜¯é€’å¢çš„

## ğŸ¯ æ ‡å‡†diffæ ¼å¼è¦æ±‚

```diff
@@ -èµ·å§‹è¡Œ,è¡Œæ•° +èµ·å§‹è¡Œ,è¡Œæ•° @@
-  è¡Œå·: åˆ é™¤çš„ä»£ç è¡Œ1
-  è¡Œå·: åˆ é™¤çš„ä»£ç è¡Œ2
+  è¡Œå·: æ·»åŠ çš„ä»£ç è¡Œ1
+  è¡Œå·: æ·»åŠ çš„ä»£ç è¡Œ2
   è¡Œå·: ä¸Šä¸‹æ–‡è¡Œ
```

**å…³é”®è¦æ±‚**:
- å…ˆæ˜¾ç¤ºæ‰€æœ‰åˆ é™¤è¡Œï¼ˆ-ï¼‰ï¼Œå†æ˜¾ç¤ºæ‰€æœ‰æ·»åŠ è¡Œï¼ˆ+ï¼‰ï¼Œæœ€åæ˜¾ç¤ºä¸Šä¸‹æ–‡è¡Œï¼ˆç©ºæ ¼ï¼‰
- æ¯ç»„å†…éƒ¨æŒ‰è¡Œå·é€’å¢æ’åº
- ä¿ç•™åŸå§‹ä»£ç ç¼©è¿›
- è¡Œå·å¿…é¡»ä¸context codeå®Œå…¨å¯¹åº”

## ğŸ”§ ä¿®å¤æµç¨‹

### æ­¥éª¤1: åˆ›å»ºä¿®å¤è„šæœ¬

åˆ›å»º `tools/fix_rc_strict.py` è„šæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒå‡½æ•°ï¼š

#### 1.1 è§£æcontextå‡½æ•°
```python
def parse_context(prompt_text):
    # è§£æ context above/below åˆ° {line_num: content}ï¼Œä¿ç•™åŸå§‹ç¼©è¿›
    ctx = {}
    
    # è§£æ context above
    m = re.search(r'The context above is:\s*```java\s*(.*?)\s*```', prompt_text, re.DOTALL)
    if m:
        block = m.group(1)
        for line in block.split('\n'):
            line = line.rstrip()
            m2 = re.match(r"\s*(\d+):(.*)$", line)  # ä¸è¦åƒæ‰å†’å·åçš„ç©ºæ ¼
            if m2:
                n = int(m2.group(1))
                code = m2.group(2)  # ä¿ç•™åŸå§‹ç¼©è¿›ï¼ŒåŒ…æ‹¬å‰å¯¼ç©ºæ ¼
                ctx[n] = code
    
    # è§£æ context below (åŒæ ·é€»è¾‘)
    # ...
    
    return ctx
```

#### 1.2 ä»£ç æ ‡å‡†åŒ–å‡½æ•°
```python
def norm_code(s: str) -> str:
    # æ ‡å‡†åŒ–ä»£ç ç”¨äºåŒ¹é…ï¼ˆä¿ç•™å­—ç¬¦ä¸²å†…å®¹ï¼›å»å¤šä½™ç©ºç™½ä¸æ³¨é‡Šï¼‰
    s = re.sub(r"\s+", " ", s.strip())
    s = re.sub(r"//.*$", "", s)
    s = re.sub(r"/\*.*?\*/", "", s, flags=re.DOTALL)
    return s.lower().strip()

def strip_existing_lineno(code: str) -> str:
    # å»æ‰è¡Œé¦–å¯èƒ½å­˜åœ¨çš„æ—§è¡Œå·æ ‡æ³¨ï¼Œä½†ä¿ç•™è¡Œå·åé¢çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬ç¼©è¿›
    return re.sub(r"^\s*\d+:", "", code)
```

#### 1.3 è¡Œå·åˆ†é…å‡½æ•°
```python
def assign_numbers_for_block(diff_text: str, ctx_map: dict):
    # æ ¸å¿ƒé€»è¾‘ï¼š
    # 1. å…ˆä¸º '+' è¡ŒåŒ¹é… context è¡Œå·ï¼ˆç²¾ç¡®åŒ¹é… + æ¨¡ç³ŠåŒ¹é…ï¼‰
    # 2. å†ä¸º ' ' è¡ŒåŒ¹é…
    # 3. ä¸º '-' è¡Œä¸ç›¸é‚» '+' è¡Œé…å¯¹å¤ç”¨è¡Œå·
    # 4. å…¶ä½™æœªç¼–å·çš„æŒ‰èŒƒå›´é¡ºåºåˆ†é…
    
    # è¾“å‡ºæ—¶æŒ‰æ ‡å‡†diffæ ¼å¼æ’åºï¼š
    # å…ˆåˆ é™¤è¡Œï¼Œå†æ·»åŠ è¡Œï¼Œæœ€åä¸Šä¸‹æ–‡è¡Œï¼Œå„ç»„å†…éƒ¨æŒ‰è¡Œå·é€’å¢
    minus_items = [it for it in line_items if it['sign'] == '-']
    plus_items = [it for it in line_items if it['sign'] == '+']
    space_items = [it for it in line_items if it['sign'] == ' ']
    
    minus_items.sort(key=lambda x: x['num'] if x['num'] is not None else 999999)
    plus_items.sort(key=lambda x: x['num'] if x['num'] is not None else 999999)
    space_items.sort(key=lambda x: x['num'] if x['num'] is not None else 999999)
    
    sorted_items = header_items + minus_items + plus_items + space_items
```

### æ­¥éª¤2: æ‰§è¡Œä¿®å¤

```bash
python tools/fix_rc_strict.py
```

### æ­¥éª¤3: éªŒè¯ç»“æœ

åˆ›å»ºéªŒè¯è„šæœ¬æ£€æŸ¥ï¼š
- è¡Œå·æ˜¯å¦ä¸contextå¯¹åº”
- diffæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆå…ˆåˆ é™¤è¡Œï¼Œå†æ·»åŠ è¡Œï¼‰
- ç¼©è¿›æ˜¯å¦ä¿ç•™
- è¡Œå·æ˜¯å¦é€’å¢

```python
# éªŒè¯è„šæœ¬ç¤ºä¾‹
def validate_diff_format(jsonl_file):
    for entry in entries:
        for rc in recent_changes:
            # æ£€æŸ¥åˆ é™¤è¡Œæ˜¯å¦åœ¨æ·»åŠ è¡Œä¹‹å‰
            # æ£€æŸ¥è¡Œå·æ˜¯å¦é€’å¢
            # æ£€æŸ¥ç¼©è¿›æ˜¯å¦ä¿ç•™
            # æ£€æŸ¥è¡Œå·æ˜¯å¦åœ¨contextä¸­å­˜åœ¨
```

## âš ï¸ å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### é”™è¯¯1: è¡Œå·äº¤é”™æ˜¾ç¤º
**é—®é¢˜**: å‡å·è¡Œå’ŒåŠ å·è¡Œäº¤é”™æ˜¾ç¤º
```diff
-  18: old code
+  18: new code  
-  19: old code
+  19: new code
```

**è§£å†³**: æŒ‰ç¬¦å·åˆ†ç»„æ’åºï¼Œå…ˆæ‰€æœ‰å‡å·è¡Œï¼Œå†æ‰€æœ‰åŠ å·è¡Œ

### é”™è¯¯2: ç¼©è¿›ä¸¢å¤±
**é—®é¢˜**: æ­£åˆ™è¡¨è¾¾å¼ `r"\s*(\d+):\s*(.*)$"` ä¼šåƒæ‰å†’å·åçš„ç©ºæ ¼

**è§£å†³**: æ”¹ä¸º `r"\s*(\d+):(.*)$"`ï¼Œä¸è¦åƒæ‰å†’å·åçš„ç©ºæ ¼

### é”™è¯¯3: è¡Œå·ä¸å¯¹åº”
**é—®é¢˜**: Recent Changesä¸­çš„è¡Œå·åœ¨contextä¸­ä¸å­˜åœ¨

**è§£å†³**: 
1. ä½¿ç”¨æ™ºèƒ½åŒ¹é…ç®—æ³•ï¼ˆç²¾ç¡®åŒ¹é… + æ¨¡ç³ŠåŒ¹é…ï¼‰
2. ä»contextä¸­è·å–æ­£ç¡®çš„ä»£ç å†…å®¹å’Œè¡Œå·
3. ç¡®ä¿æ‰€æœ‰"+"è¡Œçš„è¡Œå·éƒ½åœ¨contextä¸­å­˜åœ¨

### é”™è¯¯4: ä¸Šä¸‹æ–‡è¡Œç¼ºå°‘ç©ºæ ¼å‰ç¼€
**é—®é¢˜**: ä¸Šä¸‹æ–‡è¡Œæ˜¾ç¤ºä¸º `2: code` è€Œä¸æ˜¯ `   2: code`

**è§£å†³**: ç¡®ä¿ä¸Šä¸‹æ–‡è¡Œæœ‰æ­£ç¡®çš„ç©ºæ ¼å‰ç¼€ç¬¦å·

## ğŸ“Š éªŒè¯æ ‡å‡†

ä¿®å¤å®Œæˆåï¼Œæ¯ä¸ªRecent Changeså—åº”è¯¥æ»¡è¶³ï¼š

1. **æ ¼å¼æ­£ç¡®**: `@@ -start,count +start,count @@`
2. **é¡ºåºæ­£ç¡®**: åˆ é™¤è¡Œ â†’ æ·»åŠ è¡Œ â†’ ä¸Šä¸‹æ–‡è¡Œ
3. **è¡Œå·é€’å¢**: æ¯ç»„å†…éƒ¨è¡Œå·ä¸¥æ ¼é€’å¢
4. **ç¼©è¿›ä¿ç•™**: ä»£ç ç¼©è¿›ä¸contextå®Œå…¨ä¸€è‡´
5. **è¡Œå·å¯¹åº”**: æ‰€æœ‰è¡Œå·éƒ½èƒ½åœ¨contextä¸­æ‰¾åˆ°å¯¹åº”å†…å®¹

## ğŸ‰ æˆåŠŸæ ‡å‡†

- æ‰€æœ‰20æ¡æ•°æ®éªŒè¯é€šè¿‡
- 100%æˆåŠŸç‡
- ç¬¦åˆæ ‡å‡†unified diffæ ¼å¼
- ä¸context codeå®Œå…¨å¯¹é½

## ğŸ“ å·¥å…·æ–‡ä»¶

- `tools/fix_rc_strict.py`: æ ¸å¿ƒä¿®å¤è„šæœ¬
- `validate_final.py`: éªŒè¯è„šæœ¬  
- `final_check.py`: å®Œæ•´æ£€æŸ¥è„šæœ¬
- `debug_errors.py`: è°ƒè¯•è„šæœ¬

æŒ‰ç…§æ­¤æµç¨‹æ‰§è¡Œï¼Œå¯ä»¥ç¡®ä¿ç”Ÿæˆæ­£ç¡®çš„Benchmarkæ•°æ®ã€‚
