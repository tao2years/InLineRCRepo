# InlineEdit Recent Changes 技术方案

## 1. 方案概述

### 1.1 背景
当前InlineEdit功能基于代码上下文（above context、below context）和import内容进行代码生成，但缺少本地开发历史信息。为了提升代码生成的准确性和上下文相关性，需要引入同文件最近三次changes来补充InlineEdit的上下文信息。

### 1.2 目标
- **增强上下文理解**: 通过Recent Changes提供代码演进历史，帮助模型理解开发意图
- **提升生成质量**: 基于最近的代码变更模式，生成更符合开发习惯的代码
- **实时感知变化**: 捕获IDEA中的本地changes，提供最新的开发上下文

```

## 2. 数据组织格式

### 2.1 Context结构
扩展Recent Changes部分：

```java
// Context Above (带行号)
  1: @Service
  2: public class TResMsServiceImpl implements TResMsService {
  3:     private static final Logger LOGGER = LogManager.getLogger(TResMsServiceImpl.class);
  4:
  5:     private static final String TABLE_NAME = "t_res_micro_service";

// Context Below (带行号，为目标代码预留空间)
 101: @Override
 102:     public int update(ResMsRequestBody requestBody) throws VscServiceException {
 103:         String operateUser = DevCloudTokenStore.getUserName();
```

### 2.2 Recent Changes格式
按照优先级rc1 > rc2 > rc3组织，使用标准unified diff格式：

```diff
### Recent Change 3 (Earliest preparation work)
```diff
@@ -2,5 +2,5 @@
  2: public class TResMsServiceImpl implements TResMsService {
-  3: // TODO add logger
+  3: private static final Logger LOGGER = LogManager.getLogger(TResMsServiceImpl.class);
  4:
-  5: // TODO table name  
+  5: private static final String TABLE_NAME = "t_res_micro_service";
```

### Recent Change 2 (Intermediate preparation)
```diff
@@ -18,10 +18,10 @@
- 18: LOGGER.info("listService start");
+ 18: LOGGER.info("[begin listService][tableName={}]", TABLE_NAME);
  19: IPage page = new Page(pageNum, pageSize);
+ 20: try {
  21:   IPage<TResServiceResp> servicePage = tResMicroServiceMapper.getServiceList(page);
+ 22:   LOGGER.info("[end listService][tableName={}]", TABLE_NAME);
+ 23:   return CommonPage.restPage(servicePage);
+ 24: } catch (DataAccessException e) {
+ 25:   LOGGER.error("[listService from {} error][message = {}]", TABLE_NAME, e.getMessage());
+ 26:   throw ExceptionUtils.getSqlException(e, "query service list from database error");
+ 27: }
```

### Recent Change 1 (Latest preparation work)  
```diff
@@ -25,3 +25,8 @@
  25: LOGGER.error("[listService from {} error][message = {}]", TABLE_NAME, e.getMessage());
  26:   throw ExceptionUtils.getSqlException(e, "query service list from database error");
  27: }
+ 28:
+ 29: // TODO: Implement new method here
+ 30: // This is where the new functionality will be added
+ 31: // Based on the recent changes pattern
```
```

### 2.3 关键格式要求
- **行号标注**: 所有代码行必须有明确的行号标注（如`+ 23:`、`- 18:`）
- **diff头信息**: 使用标准格式`@@ -起始行,变更数 +起始行,变更数 @@`
- **变更符号**: 明确使用`+`表示新增，`-`表示删除，空格表示上下文
- **行号一致性**: diff中的行号必须与context中的行号完全对应
