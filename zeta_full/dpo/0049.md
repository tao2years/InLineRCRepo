<events>
User edited "crates/telemetry_sink/src/telemetry_sink.rs":
```diff
@@ -15,6 +15,8 @@
     pub insert_id: Option<String>,
 }
 
+
+
 impl SnowflakeTelemetryEvent {
     pub fn new(
         event_type: impl Into<String>,

```

User edited "crates/telemetry_sink/src/telemetry_sink.rs":
```diff
@@ -15,7 +15,7 @@
     pub insert_id: Option<String>,
 }
 
-
+fn add
 
 impl SnowflakeTelemetryEvent {
     pub fn new(

```
</events>
<input>
```crates/telemetry_sink/src/telemetry_sink.rs
<|start_of_file|>
use anyhow::{Context as _, Result};
use reqwest::header;
use serde::{Deserialize, Serialize};
use serde_json::json;
use uuid::Uuid;
<|editable_region_start|>

#[derive(Debug, Serialize, Deserialize)]
pub struct SnowflakeTelemetryEvent {
    pub time: chrono::DateTime<chrono::Utc>,
    pub user_id: Option<String>,
    pub device_id: Option<String>,
    pub event_type: String,
    pub event_properties: serde_json::Value,
    pub user_properties: Option<serde_json::Value>,
    pub insert_id: Option<String>,
}

fn add<|user_cursor_is_here|>

impl SnowflakeTelemetryEvent {
    pub fn new(
        event_type: impl Into<String>,
        metrics_id: Uuid,
        is_staff: bool,
        system_id: Option<String>,
        event_properties: serde_json::Value,
    ) -> Self {
        Self {
            time: chrono::Utc::now(),
            event_type: event_type.into(),
            device_id: system_id,
            user_id: Some(metrics_id.to_string()),
            insert_id: Some(uuid::Uuid::new_v4().to_string()),
            event_properties,
            user_properties: Some(json!({ "is_staff": is_staff })),
        }
    }
}

pub struct SnowflakeTelemetrySink {
    http_client: reqwest::Client,
    base_url: String,
    admin_api_token: String,
}

impl SnowflakeTelemetrySink {
    pub fn new(base_url: impl Into<String>, admin_api_token: impl Into<String>) -> Self {
        Self {
            http_client: reqwest::Client::new(),
            base_url: base_url.into(),
            admin_api_token: admin_api_token.into(),
        }
    }

    pub async fn write(&self, row: SnowflakeTelemetryEvent) -> Result<()> {
        self.http_client
            .post(format!("{}/snowflake/events", self.base_url))
            .header(
                header::AUTHORIZATION,
                format!("token {}", self.admin_api_token),
            )
            .header(header::CONTENT_TYPE, "application/json")
            .body(serde_json::to_string(&row)?)
            .send()
            .await
<|editable_region_end|>
            .context("failed to write event to Snowflake")?
```
</input>
<output>
```crates/telemetry_sink/src/telemetry_sink.rs
<|start_of_file|>
use anyhow::{Context as _, Result};
use reqwest::header;
use serde::{Deserialize, Serialize};
use serde_json::json;
use uuid::Uuid;
<|editable_region_start|>

#[derive(Debug, Serialize, Deserialize)]
pub struct SnowflakeTelemetryEvent {
    pub time: chrono::DateTime<chrono::Utc>,
    pub user_id: Option<String>,
    pub device_id: Option<String>,
    pub event_type: String,
    pub event_properties: serde_json::Value,
    pub user_properties: Option<serde_json::Value>,
    pub insert_id: Option<String>,
}

fn add_event(event: SnowflakeTelemetryEvent) -> Result<()> {
    Ok(())
}

impl SnowflakeTelemetryEvent {
    pub fn new(
        event_type: impl Into<String>,
        metrics_id: Uuid,
        is_staff: bool,
        system_id: Option<String>,
        event_properties: serde_json::Value,
    ) -> Self {
        Self {
            time: chrono::Utc::now(),
            event_type: event_type.into(),
            device_id: system_id,
            user_id: Some(metrics_id.to_string()),
            insert_id: Some(uuid::Uuid::new_v4().to_string()),
            event_properties,
            user_properties: Some(json!({ "is_staff": is_staff })),
        }
    }
}

pub struct SnowflakeTelemetrySink {
    http_client: reqwest::Client,
    base_url: String,
    admin_api_token: String,
}

impl SnowflakeTelemetrySink {
    pub fn new(base_url: impl Into<String>, admin_api_token: impl Into<String>) -> Self {
        Self {
            http_client: reqwest::Client::new(),
            base_url: base_url.into(),
            admin_api_token: admin_api_token.into(),
        }
    }

    pub async fn write(&self, row: SnowflakeTelemetryEvent) -> Result<()> {
        self.http_client
            .post(format!("{}/snowflake/events", self.base_url))
            .header(
                header::AUTHORIZATION,
                format!("token {}", self.admin_api_token),
            )
            .header(header::CONTENT_TYPE, "application/json")
            .body(serde_json::to_string(&row)?)
            .send()
            .await
<|editable_region_end|>
            .context("failed to write event to Snowflake")?
```
</output>
<outline>
```crates/telemetry_sink/src/telemetry_sink.rs
pub struct SnowflakeTelemetryEvent
 pub time
 pub user_id
 pub device_id
 pub event_type
 pub event_properties
 pub user_properties
 pub insert_id
pub fn new
pub struct SnowflakeTelemetrySink
 http_client
 base_url
 admin_api_token
impl SnowflakeTelemetrySink
 pub fn new
 pub async fn write
```

</outline>
<rejected>
```crates/telemetry_sink/src/telemetry_sink.rs
<|start_of_file|>
use anyhow::{Context as _, Result};
use reqwest::header;
use serde::{Deserialize, Serialize};
use serde_json::json;
use uuid::Uuid;
<|editable_region_start|>

#[derive(Debug, Serialize, Deserialize)]
pub struct SnowflakeTelemetryEvent {
    pub time: chrono::DateTime<chrono::Utc>,
    pub user_id: Option<String>,
    pub device_id: Option<String>,
    pub event_type: String,
    pub event_properties: serde_json::Value,
    pub user_properties: Option<serde_json::Value>,
    pub insert_id: Option<String>,
}

fn add_event(event: SnowflakeTelemetryEvent) -> Result<()> {
    let base_url = "https://example.com";
    let admin_api_token = "your_admin_api_token";

    let http_client = reqwest::Client::new();
    let url = format!("{}/snowflake/events", base_url);

    http_client
        .post(url)
        .header(
            header::AUTHORIZATION,
            format!("token {}", admin_api_token),
        )
        .header(header::CONTENT_TYPE, "application/json")
        .body(serde_json::to_string(&event)?)
        .send()
        .await
<|editable_region_end|>
            .context("failed to write event to Snowflake")?
```
</rejected>

<labels>
local-edit,complete-implementation
</labels>
